<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finamax - Quiz de Empréstimos</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    <style>
        .progress-bar { height: 8px; transition: width 0.5s ease; }
        .fade-in { animation: fadeIn 0.5s; }
        .fade-out { animation: fadeOut 0.5s forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .loading-spinner {
            width: 50px; height: 50px; border: 5px solid rgba(26, 32, 44, 0.2);
            border-radius: 50%; border-top-color: #1A202C; animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="font-sans bg-gray-100">
    <div class="min-h-screen flex flex-col">
        <div class="bg-gray-200 h-2 w-full">
            <div id="progressBar" class="progress-bar bg-purple-600" style="width: 0%"></div>
        </div>
        
        <header class="bg-white shadow-sm py-4">
            <div class="container mx-auto px-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center">
                        <div class="bg-purple-600 text-white font-bold rounded-lg p-2 mr-3">
                            <span class="text-xl">F</span>
                        </div>
                        <h1 class="text-xl font-bold text-gray-900">Finamax</h1>
                    </div>
                    <div class="hidden md:block">
                        <span class="text-gray-600"><i class="fas fa-phone-alt mr-2 text-purple-600"></i>0800 123 4567</span>
                    </div>
                </div>
            </div>
        </header>
        
        <main class="flex-grow container mx-auto px-4 py-8">
            <form id="quizForm">
                <div id="quizContainer" class="max-w-2xl mx-auto bg-white rounded-xl shadow-md overflow-hidden fade-in">
                    <!-- Step 2: CPF (Foco no problema) -->
                    <div id="step2" class="p-8">
                        <div class="mb-6">
                            <div class="flex items-center mb-2">
                                <span class="bg-purple-600 text-white rounded-full w-8 h-8 flex items-center justify-center mr-2">2</span>
                                <h2 class="text-xl font-bold text-gray-900">Qual é o seu CPF?</h2>
                            </div>
                            <p class="text-gray-600 ml-10 mb-4">Seu CPF é necessário para consulta de crédito.</p>
                        </div>
                        <div class="ml-10 mb-6">
                            <input type="text" id="cpf" name="cpf" class="w-full px-4 py-3 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-purple-600" placeholder="Digite seu CPF">
                        </div>
                        <div class="ml-10 text-center text-xs text-gray-500 mb-6">
                            <i class="fas fa-lock mr-1"></i> Seus dados estão 100% seguros e protegidos.
                        </div>
                        <p id="cpfError" class="text-red-500 text-center text-sm my-4 hidden ml-10"><i class="fas fa-exclamation-circle mr-1"></i> CPF inválido. Por favor, verifique os dígitos.</p>
                        <p id="cpfExistsError" class="text-red-500 text-center text-sm my-4 hidden ml-10"><i class="fas fa-exclamation-circle mr-1"></i> Este CPF já está cadastrado em nosso sistema.</p>
                        <div class="ml-10 mb-6">
                            <div id="feedback2" class="hidden bg-gray-100 text-gray-900 p-3 rounded-lg flex items-center">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                <span>+25% de chance de aprovação</span>
                            </div>
                        </div>
                        <div class="ml-10 flex justify-end">
                            <button type="button" onclick="validateAndContinue()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 disabled:opacity-50" disabled id="btnStep2">
                                Próxima pergunta <i class="fas fa-arrow-right ml-2"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </main>
        
        <footer class="bg-gray-900 text-white py-8">
            <div class="container mx-auto px-4">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <div class="mb-4 md:mb-0 text-center md:text-left">
                        <div class="flex items-center justify-center md:justify-start">
                            <div class="bg-white text-purple-600 font-bold rounded-lg p-2 mr-3">
                                <span class="text-xl">F</span>
                            </div>
                            <h3 class="text-xl font-bold">Finamax</h3>
                        </div>
                        <p class="text-sm opacity-80 mt-2">Soluções financeiras inteligentes</p>
                    </div>
                    <div class="text-xs opacity-80 text-center md:text-right space-y-1 mt-4 md:mt-0">
                        <p>Copyright © 2024 Todos os Direitos Reservados</p>
                        <p>Finamax - CNPJ/MF sob o número 00.411.939/0001-49</p>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // ✅ COLOQUE A SUA URL DO GOOGLE APPS SCRIPT AQUI
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw4XKZV__D8gYrCVMiABezllNRmcxd4hlxc2iiV5Xhr3YNW2IheuiQNc64DO0ZfLBq9/exec';
        
        // Função para validar CPF
        function testaCPF(strCPF) {
            let Soma;
            let Resto;
            let strCPFlimpo = strCPF.replace(/\D/g, '');
            Soma = 0;
            
            if (strCPFlimpo.length !== 11 || /^(\d)\1{10}$/.test(strCPFlimpo)) return false;
            
            for (let i=1; i<=9; i++) Soma += parseInt(strCPFlimpo.substring(i-1, i)) * (11 - i);
            Resto = (Soma * 10) % 11;
            
            if ((Resto === 10) || (Resto === 11)) Resto = 0;
            if (Resto !== parseInt(strCPFlimpo.substring(9, 10))) return false;
            
            Soma = 0;
            for (let i = 1; i <= 10; i++) Soma += parseInt(strCPFlimpo.substring(i-1, i)) * (12 - i);
            Resto = (Soma * 10) % 11;
            
            if ((Resto === 10) || (Resto === 11)) Resto = 0;
            if (Resto !== parseInt(strCPFlimpo.substring(10, 11))) return false;
            
            return true;
        }
        
        $(document).ready(function() {
            // Aplicar máscara ao CPF
            $('#cpf').mask('000.000.000-00', {reverse: true});
            
            // Validar CPF em tempo real
            $('#cpf').on('input', function() {
                validateCPF();
            });
        });
        
        // Função para validar o CPF
        async function validateCPF() {
            const cpf = $('#cpf').val();
            const cpfLimpo = cpf.replace(/\D/g, '');
            const isLengthValid = cpfLimpo.length === 11;
            
            // Resetar mensagens de erro
            $('#cpfError').addClass('hidden');
            $('#cpfExistsError').addClass('hidden');
            $('#btnStep2').prop('disabled', true);
            
            if (!isLengthValid) {
                return false;
            }
            
            if (!testaCPF(cpf)) {
                $('#cpfError').removeClass('hidden');
                return false;
            }
            
            // Verificar se CPF já existe no servidor
            try {
                const response = await fetch(`${SCRIPT_URL}?cpf=${cpfLimpo}`);
                const data = await response.json();
                
                if (data.result === 'success' && data.exists) {
                    $('#cpfExistsError').removeClass('hidden');
                    return false;
                }
                
                // Se chegou até aqui, o CPF é válido e não existe no sistema
                $('#btnStep2').prop('disabled', false);
                return true;
                
            } catch (error) {
                console.error('Erro ao verificar CPF:', error);
                // Em caso de erro na verificação, permitir continuar (não bloquear o usuário)
                $('#btnStep2').prop('disabled', false);
                return true;
            }
        }
        
        // Função para validar e continuar
        async function validateAndContinue() {
            const isValid = await validateCPF();
            
            if (isValid) {
                // Aqui você faria a transição para a próxima etapa
                alert('CPF válido e não duplicado. Prosseguindo para a próxima etapa...');
                // nextStep(); // Chamaria a função para ir para a próxima etapa
            }
        }
        
        // Função para enviar os dados do formulário
        async function submitQuiz() {
            const formData = {
                nomeCompleto: 'Nome Teste', // Estes valores viriam do formulário
                cpf: $('#cpf').val().replace(/\D/g, ''),
                telefone: '11999999999',
                valor: '5000'
            };

            try {
                // Enviar dados para o Google Sheets
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.result === 'success') {
                    alert('Dados enviados com sucesso!');
                } else if (result.error === 'CPF já cadastrado') {
                    alert('Erro: Este CPF já está cadastrado em nosso sistema.');
                } else {
                    alert('Erro ao enviar dados: ' + result.error);
                }
                
            } catch (error) {
                console.error('Erro ao enviar dados:', error);
                alert('Erro de conexão. Tente novamente.');
            }
        }
    </script>
    
    <!-- Botão de teste para enviar dados -->
    <div class="fixed bottom-4 right-4">
        <button onclick="submitQuiz()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">
            Testar Envio
        </button>
    </div>
</body>
</html>
